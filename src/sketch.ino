#include <SPI.h>
//while true; do stty -F /dev/ttyACM0 115200&&netcat -p 768 -l > /dev/ttyACM0; done

byte font[] = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x28, 0x28,
   0x10, 0x00, 0x18, 0x10, 0x20, 0x08, 0x10, 0x10, 0x00, 0x00, 0x00, 0x80,
   0x38, 0x10, 0x38, 0x38, 0x30, 0x7c, 0x38, 0x7c, 0x38, 0x38, 0x00, 0x00,
   0x20, 0x00, 0x04, 0x38, 0x38, 0x38, 0x3c, 0x38, 0x3c, 0x7c, 0x7c, 0x38,
   0x44, 0x38, 0x70, 0x44, 0x08, 0x82, 0x44, 0x38, 0x38, 0x38, 0x3c, 0x38,
   0x7c, 0x44, 0x44, 0x82, 0x44, 0x44, 0x7c, 0x38, 0x02, 0x38, 0x10, 0x00,
   0x08, 0x00, 0x08, 0x00, 0x40, 0x00, 0x30, 0x00, 0x04, 0x00, 0x00, 0x04,
   0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x30, 0x10, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x28, 0x28, 0x78, 0x4c, 0x14, 0x10,
   0x10, 0x10, 0x92, 0x10, 0x00, 0x00, 0x00, 0x40, 0x44, 0x18, 0x44, 0x44,
   0x28, 0x04, 0x44, 0x40, 0x44, 0x44, 0x30, 0x30, 0x10, 0x00, 0x08, 0x44,
   0x44, 0x44, 0x44, 0x44, 0x44, 0x04, 0x04, 0x44, 0x44, 0x10, 0x20, 0x44,
   0x08, 0xc6, 0x4c, 0x44, 0x48, 0x44, 0x44, 0x44, 0x10, 0x44, 0x44, 0x82,
   0x44, 0x44, 0x40, 0x08, 0x04, 0x20, 0x28, 0x00, 0x10, 0x38, 0x08, 0x00,
   0x40, 0x00, 0x48, 0x00, 0x04, 0x10, 0x10, 0x04, 0x10, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08,
   0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x10, 0x00, 0xfe, 0x14, 0x2c, 0x08, 0x00, 0x08, 0x20, 0x54, 0x10,
   0x00, 0x00, 0x00, 0x20, 0x44, 0x10, 0x40, 0x40, 0x24, 0x04, 0x04, 0x20,
   0x44, 0x44, 0x30, 0x30, 0x08, 0xfe, 0x10, 0x40, 0x74, 0x44, 0x44, 0x04,
   0x44, 0x04, 0x04, 0x04, 0x44, 0x10, 0x20, 0x24, 0x08, 0xaa, 0x54, 0x44,
   0x48, 0x44, 0x44, 0x04, 0x10, 0x44, 0x44, 0x82, 0x28, 0x28, 0x20, 0x08,
   0x08, 0x20, 0x44, 0x00, 0x00, 0x40, 0x38, 0x38, 0x70, 0x38, 0x08, 0xb8,
   0x34, 0x00, 0x00, 0x24, 0x10, 0x6d, 0x34, 0x38, 0x34, 0x58, 0x34, 0x38,
   0x38, 0x24, 0x44, 0x82, 0x44, 0x48, 0x3c, 0x08, 0x10, 0x10, 0x0c, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x28,
   0x38, 0x10, 0x14, 0x00, 0x08, 0x20, 0x38, 0xfe, 0x00, 0xfe, 0x00, 0x10,
   0x54, 0x10, 0x20, 0x30, 0x7c, 0x3c, 0x3c, 0x10, 0x38, 0x78, 0x00, 0x00,
   0x04, 0x00, 0x20, 0x20, 0x54, 0x7c, 0x3c, 0x04, 0x44, 0x3c, 0x7c, 0x74,
   0x7c, 0x10, 0x20, 0x1c, 0x08, 0x92, 0x54, 0x44, 0x38, 0x44, 0x3c, 0x38,
   0x10, 0x44, 0x28, 0x54, 0x10, 0x10, 0x10, 0x08, 0x10, 0x20, 0x00, 0x00,
   0x00, 0x78, 0x48, 0x04, 0x48, 0x44, 0x1c, 0x44, 0x4c, 0x10, 0x10, 0x14,
   0x10, 0x92, 0x48, 0x44, 0x48, 0x24, 0x0c, 0x04, 0x10, 0x24, 0x44, 0x82,
   0x28, 0x48, 0x20, 0x04, 0x10, 0x20, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0xfe, 0x50, 0x68, 0x62, 0x00,
   0x08, 0x20, 0x54, 0x10, 0x30, 0x00, 0x00, 0x08, 0x44, 0x10, 0x10, 0x40,
   0x20, 0x40, 0x44, 0x08, 0x44, 0x40, 0x30, 0x30, 0x08, 0xfe, 0x10, 0x10,
   0x74, 0x44, 0x44, 0x04, 0x44, 0x04, 0x04, 0x44, 0x44, 0x10, 0x24, 0x24,
   0x08, 0x82, 0x64, 0x44, 0x08, 0x44, 0x14, 0x40, 0x10, 0x44, 0x28, 0x54,
   0x28, 0x10, 0x08, 0x08, 0x20, 0x20, 0x00, 0x00, 0x00, 0x44, 0x48, 0x04,
   0x48, 0x7c, 0x08, 0x44, 0x44, 0x10, 0x10, 0x0c, 0x10, 0x92, 0x48, 0x44,
   0x48, 0x24, 0x04, 0x18, 0x10, 0x24, 0x44, 0x92, 0x10, 0x48, 0x10, 0x08,
   0x10, 0x10, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x28, 0x3c, 0x64, 0x22, 0x00, 0x10, 0x10, 0x92, 0x10,
   0x30, 0x00, 0x30, 0x04, 0x44, 0x10, 0x08, 0x44, 0x20, 0x44, 0x44, 0x08,
   0x44, 0x44, 0x30, 0x30, 0x10, 0x00, 0x08, 0x00, 0x04, 0x44, 0x44, 0x44,
   0x44, 0x04, 0x04, 0x44, 0x44, 0x10, 0x24, 0x44, 0x08, 0x82, 0x44, 0x44,
   0x08, 0x44, 0x24, 0x44, 0x10, 0x44, 0x10, 0x28, 0x44, 0x10, 0x04, 0x08,
   0x40, 0x20, 0x00, 0x00, 0x00, 0x44, 0x48, 0x04, 0x48, 0x04, 0x08, 0x78,
   0x44, 0x10, 0x10, 0x14, 0x10, 0x82, 0x48, 0x44, 0x38, 0x38, 0x04, 0x20,
   0x10, 0x24, 0x28, 0xaa, 0x28, 0x70, 0x08, 0x08, 0x10, 0x10, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x28,
   0x10, 0x00, 0x5c, 0x00, 0x20, 0x08, 0x10, 0x10, 0x20, 0x00, 0x30, 0x02,
   0x38, 0x38, 0x7c, 0x38, 0x70, 0x38, 0x38, 0x08, 0x38, 0x38, 0x00, 0x20,
   0x20, 0x00, 0x04, 0x10, 0x38, 0x44, 0x3c, 0x38, 0x3c, 0x7c, 0x04, 0x38,
   0x44, 0x38, 0x18, 0x44, 0x78, 0x82, 0x44, 0x38, 0x08, 0x38, 0x44, 0x38,
   0x10, 0x38, 0x10, 0x28, 0x44, 0x10, 0x7c, 0x38, 0x80, 0x38, 0x00, 0x00,
   0x00, 0xb8, 0x34, 0x38, 0xb0, 0x38, 0x08, 0x40, 0x44, 0x10, 0x10, 0x24,
   0x10, 0x82, 0x48, 0x38, 0x08, 0x20, 0x04, 0x1c, 0x10, 0x58, 0x10, 0x44,
   0x44, 0x40, 0x3c, 0x30, 0x10, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x08, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00 }; // http://overcode.yak.net






const int L = 5; // levels of brightness
const int frames = (1<<L)-1; // the least bright led will go on only once in this many redraws of the display
byte la[frames*2]; //selects one of L layers, each populated by on and off states of leds, the full bright led will be set on in all of the layers, the least bright only in the last, least displayed one. it says that the least bright layer is only displayed once, in the middle of the frames cycle
byte rnd[6][16]; // random frame offset to reduce flicker
char text[13] = "nc 10.55 768";
int lasttext; // a downward counter thats set high after a serial read
int te; // cursor




const int OE =A5;
const int B = A4;
const int A = A3;
const int ST =A2;




int oo(int x)
{
    return x<12 || (x > 23 && x < 36);
}
int g(int x)
{
    return (x > 23 && x < 36);
}
int r(int x)
{
    return (x > 35);
}




/*
byte leds[L][6][16];
//byte dirs[6][16];


void led(int x, int y, int b)
{
    int l;
    for(l=0;l<L;l++)
    {
	if (b >= L-l)
            leds[l][x/8][y] &=~ (1<<(x%8));
    	else
    	    leds[l][x/8][y] |=  (1<<(x%8));
    }
}


int getled(int x, int y)
{
    int l;
    for(l=0;l<L;l++)
	if (!(leds[l][x/8][y] & (1<<(x%8))))
	    return L-l;
    return 0;
}




void animate()
{
    static int i,j;
    led(i,j,  r(i));
    i = ++i;
    if(i > 47)
    {
	i = 0;
	j = ++j % 14;
    }
}



unsigned long fps;
unsigned long fpS;
void fps_bar()
{
    static byte i;
    static int bar;
    static unsigned long now, then, lastfps;
    led(i,15, (bar >= i));
    led(i,14, ((1l<<(47-i))&lastfps));
    i++;
    if(i>47)
    {
	bar = fps*5/((now = millis()) - then);
	lastfps = fpS*1000/now;
	then = now;
	fps = 0;
	i=0;
    };
}



typedef struct
{
    int a,b;
    int x,y;

} particle;
const int PS = 1;
particle ps[PS];


void wrap(int i)
{
        if(ps[i].x>47)
		ps[i].x=0;
        if(ps[i].x<0)
		ps[i].x=47;
        if(ps[i].y>15)
		ps[i].y=0;
        if(ps[i].y<0)
		ps[i].y=15;
}

void bounce(int i)
{
        if(ps[i].x>46)
		ps[i].a=-ps[i].a;
        if(ps[i].x<1)
		ps[i].a=-ps[i].a;
        if(ps[i].y>12)
		ps[i].b=-ps[i].b;
        if(ps[i].y<1)
		ps[i].b=-ps[i].b;
}



void boing()
{
    int i;
    for (i=0;i<PS;i++)
    {
    	led(ps[i].x,ps[i].y,0);
	bounce(i);
        ps[i].x+=ps[i].a;
	ps[i].y+=ps[i].b;
        led(ps[i].x,ps[i].y,1+!oo(ps[i].x));
    }
}



void setupleds()
{
    int i,j;
    	for(i = 0; i < 6*8; i++)
	{
	    int o = ( i > 40 );
    	    for(j = 0; j < 16; j++)
		led(i,j, 0);
	}


    for (i=0;i<PS;i++)
    {
        ps[i].a=-2*random(2)+1;
        ps[i].b=-2+random(2)+1;
        ps[i].x=random(46)+1;
        ps[i].y=random(11)+1;
    }
}


setuplayers()
{
	int f;
	for(f=0;f<frames*2;f++)
	{
            int lap=0;
	    while(lap!=L-1)
            {
		    if(f & (1<<(lap/2)))
			break;
		    lap++;
            }
            la[f]=lap;
        }
}



*/

void setup()
{
    Serial.begin(115200);
    pinMode(A,OUTPUT);
    pinMode(B,OUTPUT);
    pinMode(ST,OUTPUT);
    pinMode(OE,OUTPUT);
    SPI.begin();
    SPI.setBitOrder(LSBFIRST);
    SPI.setClockDivider(128);
    pinMode(A0, INPUT);
    randomSeed(analogRead(A0));



    int i,j;
    
    
    for(i=0;i<6;i++)
	for(j=0;j<16;j++)
	    rnd[i][j] = random(frames);
    
}

void textin()
{

	if(lasttext < 16 && Serial.available())
	{
		char in  =  Serial.read();
		if (in != 10)
		{
		    text[te] = in;
		    if(++te>11)
			te = 0;
		}
		lasttext = 20;
	}
	if(lasttext)
		lasttext--;

}



int row,frame=1;
int animator;
void loop()
{
    int i,j,k=0;
    for(i = 0; i < 6; i++)
        for(j = 0; j < 4; j++)
        {
//    	    int b = la[L-1];// ( rnd[i][j] + frame)];
//	    SPI.transfer(random(255));
//	    SPI.transfer(leds[b][i][row+j*4]);
	    SPI.transfer((rnd[i][j]+frame == frames)  ?  (~font[   text[i+(row+j*4)/8*6]    +128*((row+j*4)%8)]   &   ((((row+j*4)%8==7)   &&    (te/6==(row+j*4)/8)    &&    (te%6==i)    ?   ~ lasttext    :    0xff))) : 255);
	}








    PORTC |= 36;
    PORTC = 219 & (row<<3);








//    fps++;fpS++;





    if(row++ == 3)
    {
	row = 0;
        if (++frame > (1<<L)-1)
        {
	    frame = 1;
	    textin();
	}
    }
}

















/*
    digitalWrite(ST,0);
    digitalWrite(OE,1);
    digitalWrite(ST,1);
    digitalWrite(A, row&1);
    digitalWrite(B, row&2);
    digitalWrite(OE,0);
*/


//	led(random(6*8),random(16),random(L));
